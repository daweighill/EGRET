---
title: "finalEgret v1 validation: validating 'leave-one-out' egret networks"
author: "Deborah Weighill"
date: "June 19, 2020"
output:
  html_notebook:
    toc: true
    theme: cosmo
    df_print: paged
---


Here we validate the PANDA and EGRET networks against ChIP-seq data.

# Make Panda/EGRET edge table

Load all of the PANDA/EGRET regnets

```{r echo=FALSE,results='hide'}
library(reshape2)
# panda"
"../outputs/"
load("../outputs/finalEGRET_v1_noQbic_na12878_06192020_panda.RData")
net <- melt(regnet)
colnames(net) = c("tf","gene","score")
net$id <- paste0(net$tf,net$gene)

regnet_edge_table <- data.frame(net$id)
colnames(regnet_edge_table) <- c("id")
regnet_edge_table$tf <- as.vector(net$tf)
regnet_edge_table$gene <- as.vector(net$gene)
regnet_edge_table$panda <- as.vector(net$score)

#list of the file names of the rest of the networks
files <- c("finalEGRET_v1_noExpr_na12878_06192020_egret.RData",
"finalEGRET_v1_noExpr_na12878_06192020_panda.RData",
"finalEgret_v1_noPPI_na12878_06192020_egret.RData",
"finalEgret_v1_noPPI_na12878_06192020_panda.RData",
"finalEGRET_v1_noQbic_na12878_06192020_egret.RData",   
"finalEgret_v1_onlyQbic_na12878_06192020_egret.RData",
"finalEGRET_v1_onlyQTL_na12878_06192020_egret.RData",  
 "finalEgret_v1_na12878_eQTLs_06182020_egret.RData")


#nicknames of the networks
names <- c("egret_noExp","panda_noExp","egret_noPPI","panda_noPPI","egret_noQbic","egret_onlyQbic","egret_onlyQTL","egret_complete")



for (p in c(1:8)) {
  filename <- paste0("../outputs/",files[p])
  netname <- names[p]
  print(netname)
  load(filename)
  net <- melt(regnet)
  colnames(net) = c("tf","gene","score")
  net$id <- paste0(net$tf,net$gene)
  if(all.equal(as.vector(regnet_edge_table$id),as.vector(net$id))){
    print(p)
    regnet_edge_table$tempID <- as.vector(net$score)
    #print(colnames(regnet_edge_table))
    colnames(regnet_edge_table)[colnames(regnet_edge_table) == "tempID"] <- netname
  }
}

save(regnet_edge_table, file = "../outputs/finalEGRET_v1_LOO_06192020_edge_table.RData")
#load("../outputs/")
```

# Load ChIP-seq data
We load the chipseq data and make a ground truth regulatory network for validation.

```{r echo=FALSE,results='hide'}
library(rtracklayer)
library(tidyr)
library(pROC)
library(reshape)
library(PRROC)
library(dplyr)

# read in the gene annotation file with gene ranges.
genes <- read.table("../annotation/ensembl_genes_from_ucsc.txt", header = TRUE,sep = "\t")
genes$promotorLeft <- ifelse(genes$strand == "+", (genes$txStart + 1 - 750), (genes$txEnd-250))
genes$promotorRight <- ifelse(genes$strand == "+", (genes$txStart + 1 + 250), (genes$txEnd+750))
gr_genes_promotor <- GRanges(seqnames = genes$chrom, ranges = IRanges(start = genes$promotorLeft, end = genes$promotorRight), strand = NULL, mcols = genes[,13:15])

# GM12878 chipseq data
gr_chipseq_gm12878 <- import("../../ca_egret/ca_egret_v3.1_LOO/validation/GM12878_remap2018_all_macs2_hg19_v1_2.bed")
overlaps_gm12878 <- data.frame(findOverlaps(gr_chipseq_gm12878, gr_genes_promotor))
overlaps_gm12878$tf_name <- gr_chipseq_gm12878$name[overlaps_gm12878$queryHits]
overlaps_gm12878$gene_name <- gr_genes_promotor$mcols.name2[overlaps_gm12878$subjectHits]
validation_regnet_gm12878 <- separate(overlaps_gm12878, tf_name, c("exp", "tf", "cell line"), "\\.")
chipseq_regnet_gm12878 <- distinct(validation_regnet_gm12878[,c("tf","gene_name")])
chipseq_regnet_gm12878$id <- paste0(chipseq_regnet_gm12878$tf,chipseq_regnet_gm12878$gene)
```

# Overlap networks with ChIP-seq data
We now filter down the panda/egret networks to only include those TFs which are in the ChIP-seq data (our validation set). We do the same for the prior networks.
```{r echo=FALSE,results='hide'}
# gm12878
filtered_net_table_gm12878 <- regnet_edge_table[(regnet_edge_table$tf %in% chipseq_regnet_gm12878$tf) ,]
filtered_net_table_gm12878$chipseq <- ifelse(filtered_net_table_gm12878$id %in% chipseq_regnet_gm12878$id,1,0)
```

# Validate entire networks

Plot ROC/PR curves for each PANDA and EGRET nework, as well as table of AUCs and PRs
```{r}
library(pROC)
library(precrec)
library(ggplot2)
# GM12878 validation
for (i in c(4:12)){
  specs <- colnames(filtered_net_table_gm12878)[i]
  curve <- evalmod(scores = filtered_net_table_gm12878[,i], labels = as.factor(filtered_net_table_gm12878$chipseq),modnames = c(specs))
  #curves <- evalmod(curve_data)
  autoplot(curve)
  aucs <- auc(curve)
  print(aucs)
}
```



# Validate highest difference edges with chipseq
## GM12878
```{r echo=FALSE,results='hide'}
#calculate differences
#nicknames of the networks

filtered_net_table_gm12878$diff_egret_complete <- abs(filtered_net_table_gm12878$egret_complete - filtered_net_table_gm12878$panda)
filtered_net_table_gm12878$diff_egret_noQbic <- abs(filtered_net_table_gm12878$egret_noQbic - filtered_net_table_gm12878$panda)
filtered_net_table_gm12878$diff_egret_onlyQbic <- abs(filtered_net_table_gm12878$egret_onlyQbic - filtered_net_table_gm12878$panda)
filtered_net_table_gm12878$diff_egret_onlyQTL <- abs(filtered_net_table_gm12878$egret_onlyQTL - filtered_net_table_gm12878$panda)
filtered_net_table_gm12878$diff_egret_noExp <- abs(filtered_net_table_gm12878$egret_noExp - filtered_net_table_gm12878$panda_noExp)
filtered_net_table_gm12878$diff_egret_noPPI <- abs(filtered_net_table_gm12878$egret_noPPI - filtered_net_table_gm12878$panda_noPPI)

filtered_net_table_gm12878$net_egret_complete <- filtered_net_table_gm12878$egret_complete
filtered_net_table_gm12878$net_egret_noQbic <- filtered_net_table_gm12878$egret_noQbic
filtered_net_table_gm12878$net_egret_onlyQbic <- filtered_net_table_gm12878$egret_onlyQbic
filtered_net_table_gm12878$net_egret_onlyQTL <- filtered_net_table_gm12878$egret_onlyQTL
filtered_net_table_gm12878$net_egret_noExp <- filtered_net_table_gm12878$egret_noExp
filtered_net_table_gm12878$net_egret_noPPI <- filtered_net_table_gm12878$egret_noPPI


validation_table_gm12878 <- filtered_net_table_gm12878
save(validation_table_gm12878, file = "../outputs/validation_table_finalEGRET_v1_LOO_06192020_gm12878.RData")
#load("../outputs/validation_table_3.0_gm12878.RData")
```

```{r,results='hide',fig.show=TRUE}
library(precrec)
library(ggplot2)

names <- c("egret_complete", "egret_noQbic", "egret_onlyQbic", "egret_onlyQTL","egret_noExp", "egret_noPPI")
diff_cols <- c(14,15,16,17,18,19)
egret_net_nums <- c(20,21,22,23,24,25)
panda_net_nums <- c(4,4,4,4,6,8)
chipseq_col <- 13
get_roc_for_diff_thresh <- function(egretNum, thresh) {
  diffcolnum <- diff_cols[egretNum]
  egretcol <- egret_net_nums[egretNum]
  panda_col <- panda_net_nums[egretNum]
  
  top_diff_table <- validation_table_gm12878[(validation_table_gm12878[,c(diffcolnum)]>thresh),c(panda_col,egretcol,chipseq_col)]
  scores <- join_scores(top_diff_table[,1],top_diff_table[,2])
  labels <- join_labels(top_diff_table[,3],top_diff_table[,3])
  specs <- paste0(names[egretNum],", thresh: ",thresh)
  
  rocP <- roc(top_diff_table$chipseq, top_diff_table[,1], auc = TRUE, direction = "<")
  rocE <- roc(top_diff_table$chipseq, top_diff_table[,2],auc = TRUE, direction = "<")
  test <- roc.test(rocP, rocE, alternative = "less", method = "delong" )
  pandaAUC <- test$estimate["AUC of roc1"]
  egretAUC <- test$estimate["AUC of roc2"]
  pval <- test$p.value
  print(paste(egretNum,thresh,pval))
  
  curve_data <- mmdata(scores, labels,modnames = c("panda", specs), dsids = c(1, 2))
  curves <- evalmod(curve_data)
  nn <- attr(curves$rocs,"data_info")$nn[1]
  np <- attr(curves$rocs,"data_info")$np[1]
  result <- c(egretNum, names[egretNum], thresh, nn, np, pandaAUC, egretAUC, pval)
  return(result)
  autoplot(curves)
}

egret_priors <- c(1:6)
thresholds <- c(0.1, 0.15, 0.2, 0.25, 0.5, 0.75,1,2)
#thresholds <- c(0.05,0.1,0.25,0.5,0.75,1)

egret_auc_pvals_gm12878 <- data.frame()

for (p in egret_priors){
  for (t in thresholds){
    result <- get_roc_for_diff_thresh(p,t)
    df <- data.frame(t(result), stringsAsFactors = FALSE)
    egret_auc_pvals_gm12878 <- rbind(egret_auc_pvals_gm12878,df)
  }
}

colnames(egret_auc_pvals_gm12878) <- c("egretNum", "name", "thresh", "nn", "np", "pandaAUC", "egretAUC", "pval")
write.table(egret_auc_pvals_gm12878, file = "../outputs/finalEGRET_v1_LOO_06192020_auc_pvals_gm12878.txt", sep = "\t", col.names = TRUE, quote=FALSE)
egret_auc_pvals_gm12878
```



```{r}
egret_auc_pvals_gm12878 <- data.frame()
egret_priors <- c(3)
thresholds <- c(0.5, 0.75,1,2,3,4,5,6,7,8,9,10,11)
for (p in egret_priors){
  for (t in thresholds){
    result <- get_roc_for_diff_thresh(p,t)
    df <- data.frame(t(result), stringsAsFactors = FALSE)
    egret_auc_pvals_gm12878 <- rbind(egret_auc_pvals_gm12878,df)
  }
}

colnames(egret_auc_pvals_gm12878) <- c("egretNum", "name", "thresh", "nn", "np", "pandaAUC", "egretAUC", "pval")
egret_auc_pvals_gm12878
```


```{r}
egret_auc_pvals_gm12878 <- data.frame()
egret_priors <- c(2)
thresholds <- c(0.5, 0.75,1,2,3,4,5)
for (p in egret_priors){
  for (t in thresholds){
    result <- get_roc_for_diff_thresh(p,t)
    df <- data.frame(t(result), stringsAsFactors = FALSE)
    egret_auc_pvals_gm12878 <- rbind(egret_auc_pvals_gm12878,df)
  }
}

colnames(egret_auc_pvals_gm12878) <- c("egretNum", "name", "thresh", "nn", "np", "pandaAUC", "egretAUC", "pval")
egret_auc_pvals_gm12878
```

```{r}
egret_auc_pvals_gm12878 <- data.frame()
egret_priors <- c(4)
thresholds <- c(0.5, 0.75,1,2,3,4,5)
for (p in egret_priors){
  for (t in thresholds){
    result <- get_roc_for_diff_thresh(p,t)
    df <- data.frame(t(result), stringsAsFactors = FALSE)
    egret_auc_pvals_gm12878 <- rbind(egret_auc_pvals_gm12878,df)
  }
}

colnames(egret_auc_pvals_gm12878) <- c("egretNum", "name", "thresh", "nn", "np", "pandaAUC", "egretAUC", "pval")
egret_auc_pvals_gm12878
```




```{r}
library(ggplot2)
egret_auc_pvals_gm12878 <- read.table("../outputs/finalEGRET_v1_LOO_06192020_auc_pvals_gm12878.txt", header = TRUE)

egret_auc_pvals_gm12878$nodesize <- ifelse(egret_auc_pvals_gm12878$pval < 0.05, 0.45, 0.4)
egret_auc_pvals_gm12878$signif <- ifelse(egret_auc_pvals_gm12878$pval < 0.05, "significant", "non-significant")
ggplot(data = egret_auc_pvals_gm12878, aes(x = thresh, y = egretAUC, group = name, col = name)) + geom_line() + geom_point(aes(size = nodesize))
```




```{r}
egret_auc_pvals_gm12878$point <- as.factor(egret_auc_pvals_gm12878$signif)
ggplot(data = egret_auc_pvals_gm12878[egret_auc_pvals_gm12878$name == "egret_complete",], aes(x = thresh, y = egretAUC-pandaAUC)) + geom_point(size = 2.5, stroke = 0.2, aes(col = -log10(pval),shape = point)) +  scale_color_material(palette = "teal") + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 

```





Leave one out AUC bar plot
```{r}
priors_to_plot <- c("egret_complete", "egret_noQbic", "egret_onlyQbic", "egret_onlyQTL","egret_noExp", "egret_noPPI")


  
ggplot(data = egret_auc_pvals_gm12878[which((egret_auc_pvals_gm12878$name %in% priors_to_plot)& (egret_auc_pvals_gm12878$thresh == 0.5)),], aes(x = reorder(name,-egretAUC) , y = egretAUC, group = name, fill = name)) + geom_bar(stat="identity") + theme_linedraw()  + coord_cartesian(ylim=c(0.45,0.8))+  theme(text = element_text(size=12)) +  scale_fill_brewer(palette = "Dark2") + scale_x_discrete("EGRET prior",labels=c("no Expr","no PPI","all data","only QBiC","only QTL","no QBiC")) +  labs(y = "EGRET AUC-ROC", fill = "EGRET prior", title = "EGRET AUC-ROCs with combinations of data types")
```


```{r}
egret_auc_pvals_gm12878[which(egret_auc_pvals_gm12878$pval < 0.01),]

egret_auc_pvals_gm12878[which(egret_auc_pvals_gm12878$pval < 0.001),]
```

```{r, fig.show=TRUE, echo=FALSE,results='hide'}
names <- c("egret_complete", "egret_noQbic", "egret_onlyQbic", "egret_onlyQTL","egret_noExp", "egret_noPPI")
diff_cols <- c(14,15,16,17,18,19)
egret_net_nums <- c(20,21,22,23,24,25)
panda_net_nums <- c(4,4,4,4,6,8)
chipseq_col <- 13
get_roc_for_diff_thresh <- function(egretNum, thresh) {
  diffcolnum <- diff_cols[egretNum]
  egretcol <- egret_net_nums[egretNum]
  panda_col <- panda_net_nums[egretNum]
  
  top_diff_table <- validation_table_gm12878[(validation_table_gm12878[,c(diffcolnum)]>thresh),c(panda_col,egretcol,chipseq_col)]
  scores <- join_scores(top_diff_table[,1],top_diff_table[,2])
  labels <- join_labels(top_diff_table[,3],top_diff_table[,3])
  specs <- paste0(names[egretNum],", thresh: ",thresh)
  curve_data <- mmdata(scores, labels,modnames = c("panda", specs), dsids = c(1, 2))
  curves <- evalmod(curve_data)
  aucs <- auc(curves)
  print(aucs)
  autoplot(curves)
}


egret_priors <- c(1:5)
thresholds <- c(0.5)
#thresholds <- c(0.05,0.1,0.25,0.5,0.75,1)

egret_auc_pvals_gm12878 <- data.frame()

for (p in egret_priors){
  for (t in thresholds){
    get_roc_for_diff_thresh(p,t)
  }
}
```
